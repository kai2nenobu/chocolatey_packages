name: Continuous Build

on:
  workflow_dispatch: # Enable manual trigger
    inputs:
      git_ref:
        description: Reference of git (like refs/heads/master or refs/tags/v1.0.0)
        required: true
  push:
    branches: 'package/*'
    tags: '*'

env:
  MINGW_ROOT: 'C:\MinGW'
  MSYS2_ROOT: 'C:\msys64'

jobs:
  init:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v2
      - name: Check a build environment
        run: |
          Get-CimInstance win32_operatingsystem -Property Caption, OSArchitecture, Version | fl Caption, OSArchitecture, Version
          $PSVersionTable
          git --version
          choco --version
      - name: Detect a target package # from a tag name or a branch name
        run: |
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            # Overwrite GITHUB_REF with a trigger input
            $env:GITHUB_REF = '${{ github.event.inputs.git_ref }}'
          }
          $refs = $env:GITHUB_REF -split '/'
          if ($refs[1] -eq 'tags') {
            $packageId = $refs[2]
          } else if (($refs[1] -eq 'heads') -and ($res[2] -eq 'package')) {
            $packageId = $refs[3]
          } else {
            $message = 'Cannot extract a package id from ref "{0}"' -f $env:GITHUB_REF
            Write-Error -Message $message
            exit 1
          }
      - name: Package
        run: Write-Host "Packaging $env:PACKAGE_ID"
      - name: Publish
        run: Write-Host "Publishing $env:PACKAGE_ID"
